@model CineReview.Client.Features.Movies.PaginatedMovies?

@{
    ViewData["Title"] = "Đang chiếu nổi bật";
    var loadError = ViewData["LoadError"] as string;
}

@if (!string.IsNullOrWhiteSpace(loadError))
{
    <section class="container-xl py-5 my-5 text-center">
        <div class="alert alert-danger bg-danger-subtle border-danger-subtle text-danger-emphasis" role="alert">
            @loadError
        </div>
    </section>
}
else if (Model is null)
{
    <section class="container-xl py-5 my-5 text-center">
        <div class="spinner-border text-info" role="status"></div>
    </section>
}
else if (Model.TotalResults == 0)
{
    <section class="container-xl py-5 my-5 text-center">
        <h1 class="display-5 text-white mb-3">Chưa có dữ liệu phim đang chiếu</h1>
        <p class="text-secondary mb-4">Vui lòng thử lại sau hoặc quay về trang chủ để khám phá các danh mục khác.</p>
        <a class="btn btn-outline-info" href="@Url.Action("Index", "Home")">Quay lại trang chủ</a>
    </section>
}
else
{
    <section class="container-xl py-5 my-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
            <div>
                <p class="text-secondary text-uppercase small fw-semibold mb-2">Trang @Model.Page/@Model.TotalPages · @Model.TotalResults phim</p>
                <h1 class="display-5 fw-bold text-white mb-2">@Model.Title</h1>
                <p class="text-secondary mb-0">@Model.Description</p>
            </div>
            <a class="btn btn-ghost" href="@Url.Action("Index", "Home")">Quay lại trang chủ</a>
        </div>

        <div class="row g-4">
            @foreach (var movie in Model.Items)
            {
                <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
                    @await Html.PartialAsync("_MovieCard", movie)
                </div>
            }
        </div>

        @if (Model.TotalPages > 1)
        {
            <nav class="mt-5" aria-label="Phân trang phim đang chiếu">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(Model.Page <= 1 ? "disabled" : null)">
                        <a class="page-link" href="@BuildPageUrl(Model.Page - 1)" aria-label="Trang trước">&lsaquo;</a>
                    </li>
                    @foreach (var pageNumber in GetPageNumbers(Model.Page, Model.TotalPages))
                    {
                        <li class="page-item @(pageNumber == Model.Page ? "active" : null)">
                            <a class="page-link" href="@BuildPageUrl(pageNumber)">@pageNumber</a>
                        </li>
                    }
                    <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : null)">
                        <a class="page-link" href="@BuildPageUrl(Model.Page + 1)" aria-label="Trang sau">&rsaquo;</a>
                    </li>
                </ul>
            </nav>
        }
    </section>
}

@functions {
    private static IEnumerable<int> GetPageNumbers(int current, int total)
    {
        const int window = 5;
        var start = Math.Max(1, current - 2);
        var end = Math.Min(total, start + window - 1);
        start = Math.Max(1, end - window + 1);

        for (var page = start; page <= end; page++)
        {
            yield return page;
        }
    }

    private string BuildPageUrl(int page)
    {
        if (page <= 1)
        {
            return Url.Action("NowPlaying", "Movies") ?? string.Empty;
        }

        return Url.Action("NowPlaying", "Movies", new { page }) ?? string.Empty;
    }
}
