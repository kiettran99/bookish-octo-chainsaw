@using CineReview.Client.Features.Movies
@model HomePageData?

@{
    ViewData["Title"] = "CineReview";
    var homeData = Model;
    var loadError = ViewData["LoadError"] as string;
}

@if (!string.IsNullOrWhiteSpace(loadError))
{
    <section class="container-xl py-5 my-5 text-center">
        <div class="alert alert-danger bg-danger-subtle border-danger-subtle text-danger-emphasis" role="alert">
            @loadError
        </div>
    </section>
}
else if (homeData is null)
{
    <section class="container-xl py-5 my-5 text-center">
        <div class="spinner-border text-info" role="status"></div>
    </section>
}
else
{
    var featured = homeData.Featured;
    <div class="home-page">
        <section class="home-hero position-relative overflow-hidden">
            <div class="home-hero__backdrop" style="background-image: url('@featured.BackdropUrl');"></div>
            <div class="home-hero__overlay"></div>
            <div class="container-xl position-relative">
                <div class="home-hero__layout-mobile d-md-none">
                    <div class="home-hero__media d-flex flex-column align-items-center justify-content-center mb-3">
                        <div class="rounded-4 overflow-hidden shadow-lg" style="min-width: 180px; max-width: 320px; min-height: 270px; background: #222;">
                            @if (!string.IsNullOrWhiteSpace(featured.PosterUrl))
                            {
                                <img src="@featured.PosterUrl" alt="Poster @featured.Title" class="w-100 h-100 object-fit-cover" loading="lazy" />
                            }
                            else
                            {
                                <img src="/images/no-poster.png" alt="Không có poster" class="w-100 h-100 object-fit-cover opacity-50" />
                            }
                        </div>
                        <span class="badge chip chip--primary pt-2">Phim nổi bật</span>
                    </div>
                    <h1 class="home-hero__title fw-bold text-white mb-2 text-center">@featured.Title</h1>
                    <p class="home-hero__tagline text-light-emphasis mb-2 text-center text-truncate-2">@featured.Tagline</p>
                    <div class="home-hero__meta d-flex flex-wrap justify-content-center gap-2 mb-3">
                        <span class="badge chip chip--muted">@string.Join(" • ", featured.Genres.Take(3))</span>
                        <span class="text-secondary">@FormatRelease(featured.ReleaseDate)</span>
                        <span class="badge chip chip--info">@featured.CommunityScore.ToString("0.0")</span>
                        @if (featured.IsNowPlaying)
                        {
                            <span class="badge chip chip--success fw-semibold">Đang công chiếu</span>
                        }
                        else
                        {
                            <span class="badge chip chip--muted fw-semibold">Sắp khởi chiếu</span>
                        }
                    </div>
                    <p class="home-hero__overview text-secondary-emphasis mb-4 text-center">@featured.Overview</p>
                    <div class="home-hero__actions d-flex flex-column gap-3 mb-4 align-items-center">
                        <a class="btn btn-primary btn-glow w-100 py-3 fs-5 shadow-sm" style="border-radius: 1.5rem;" href="@Url.Action("Detail", "Movies", new { id = featured.Id })">Khám phá chi tiết</a>
                        <a class="btn btn-ghost w-100 py-3 fs-5" style="border-radius: 1.5rem; border: 1.5px solid #444;" href="#now-playing">Xem suất chiếu</a>
                    </div>
                </div>
                <div class="home-hero__layout d-none d-md-grid">
                    <div class="home-hero__copy">
                        <div class="home-hero__headline">
                            <span class="badge chip chip--primary">Phim nổi bật</span>
                            <span class="home-hero__date text-secondary text-uppercase fw-semibold">@featured.ReleaseDate.ToString("dd MMM yyyy")</span>
                        </div>
                        <h1 class="home-hero__title fw-bold text-white mb-3">@featured.Title</h1>
                        <p class="home-hero__tagline text-light-emphasis mb-3">@featured.Tagline</p>
                        <p class="home-hero__overview text-secondary-emphasis mb-4">@featured.Overview</p>
                        <div class="home-hero__actions d-flex flex-wrap gap-3 mb-4">
                            <a class="btn btn-primary btn-glow" href="@Url.Action("Detail", "Movies", new { id = featured.Id })">Khám phá chi tiết</a>
                            <a class="btn btn-ghost" href="#now-playing">Xem suất chiếu</a>
                        </div>
                        <div class="home-hero__meta">
                            <div class="home-hero__meta-item">
                                <span class="home-hero__meta-label">Điểm cộng đồng:</span>
                                <span class="home-hero__meta-value">@featured.CommunityScore.ToString("0.0")</span>
                            </div>
                            <div class="home-hero__meta-item">
                                <span class="home-hero__meta-label">Tình trạng:</span>
                                @if (featured.IsNowPlaying)
                                {
                                    <span class="badge chip chip--success fw-semibold">Đang công chiếu</span>
                                }
                                else
                                {
                                    <span class="badge chip chip--muted fw-semibold">Sắp khởi chiếu</span>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="home-hero__media d-flex flex-column align-items-center justify-content-center">
                        <div class="home-hero__poster-card d-flex flex-column align-items-center">
                            <div class="rounded-4 overflow-hidden shadow-lg mb-3">
                                <img src="@featured.PosterUrl" alt="Poster @featured.Title" class="w-100 h-100 object-fit-cover" loading="lazy" />
                            </div>
                            <div class="home-hero__poster-meta d-flex flex-column align-items-center gap-1">
                                <span class="badge chip chip--muted">@string.Join(" • ", featured.Genres.Take(3))</span>
                                <span class="text-secondary">@FormatRelease(featured.ReleaseDate)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="now-playing" class="home-section">
            <div class="container-xl">
                <div class="section-header">
                    <div>
                        <h2 class="h3 text-white mb-1">Đang chiếu nổi bật</h2>
                        <p class="text-secondary mb-0">Các suất chiếu đang mở bán tại Việt Nam, cập nhật theo lịch phát hành mới nhất.</p>
                    </div>
                    <a class="btn btn-ghost btn-sm" href="@Url.Action("NowPlaying", "Movies")">Xem tất cả</a>
                </div>
                <div class="cards-scroller d-md-none" aria-label="Đang chiếu nổi bật">
                    @foreach (var movie in homeData.NowPlaying)
                    {
                        <article class="cards-scroller__item">
                            @await Html.PartialAsync("_MovieCard", movie)
                        </article>
                    }
                </div>
                <a class="btn btn-ghost w-100 mt-3 d-md-none" href="@Url.Action("NowPlaying", "Movies")">Xem tất cả</a>
                <div class="row g-4 d-none d-md-flex">
                    @foreach (var movie in homeData.NowPlaying)
                    {
                        <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
                            @await Html.PartialAsync("_MovieCard", movie)
                        </div>
                    }
                </div>
            </div>
        </section>

        <section id="coming-soon" class="home-section">
            <div class="container-xl">
                <div class="section-header">
                    <div>
                        <h2 class="h3 text-white mb-1">Sắp công chiếu</h2>
                        <p class="text-secondary mb-0">Đặt nhắc lịch để không bỏ lỡ vé early-access.</p>
                    </div>
                <a class="btn btn-ghost btn-sm" href="@Url.Action("ComingSoon", "Movies")">Xem Tất Cả</a>
                </div>
                <div class="cards-scroller d-md-none" aria-label="Sắp công chiếu">
                    @foreach (var movie in homeData.ComingSoon)
                    {
                        <article class="cards-scroller__item">
                            @await Html.PartialAsync("_MovieCard", movie)
                        </article>
                    }
                </div>
                <a class="btn btn-ghost w-100 mt-3 d-md-none" href="@Url.Action("ComingSoon", "Movies")">Xem tất cả</a>
                <div class="row g-4 d-none d-md-flex">
                    @foreach (var movie in homeData.ComingSoon)
                    {
                        <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
                            @await Html.PartialAsync("_MovieCard", movie)
                        </div>
                    }
                </div>
            </div>
        </section>

        <section id="latest-reviews" class="home-section home-section--tinted">
            <div class="container-xl">
                <div class="section-header">
                    <div>
                        <h2 class="h3 text-white mb-1">Review mới nhất</h2>
                        <p class="text-secondary mb-0">Tổng hợp phản hồi từ cộng đồng CineReview.</p>
                    </div>
                    <a class="btn btn-ghost btn-sm" href="#communities">Vào cộng đồng</a>
                </div>
                <div class="row g-4">
                    @foreach (var review in homeData.LatestReviews)
                    {
                        <div class="col-12 col-lg-6">
                            <div class="review-card h-100">
                                <div class="d-flex align-items-start gap-3">
                                    <img src="@review.AvatarUrl" alt="Avatar @review.Author" class="rounded-circle flex-shrink-0 review-card__avatar" loading="lazy" />
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <h3 class="h6 text-white mb-0">@review.Author</h3>
                                            <span class="badge chip chip--warning">@review.Rating/10</span>
                                        </div>
                                        <div class="text-secondary small mb-2">
                                            <span>@review.ContextLabel</span>
                                            <span class="mx-2">•</span>
                                            <span>@review.CreatedAt.ToString("dd/MM/yyyy")</span>
                                        </div>
                                        <p class="text-secondary mb-2">@review.Excerpt</p>
                                        <div class="d-flex align-items-center gap-2 small">
                                            @if (!string.IsNullOrWhiteSpace(review.Location))
                                            {
                                                <span class="text-secondary">@review.Location</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </section>

        <section id="insights" class="home-section">
            <div class="container-xl">
                <div class="section-header">
                    <div>
                        <h2 class="h3 text-white mb-1">Bài viết & hướng dẫn</h2>
                        <p class="text-secondary mb-0">Tin tức, kinh nghiệm săn vé sớm và mẹo review chất lượng.</p>
                    </div>
                    <a class="btn btn-ghost btn-sm" href="#">Xem thêm bài viết</a>
                </div>
                <div class="row g-4">
                    @foreach (var spotlight in homeData.EditorialSpots)
                    {
                        <div class="col-12 col-lg-6">
                            <article class="editorial-card h-100">
                                <div class="editorial-card__image rounded-4 overflow-hidden">
                                    <img src="@spotlight.ImageUrl" alt="@spotlight.Title" class="w-100 h-100 object-fit-cover" loading="lazy" />
                                </div>
                                <div class="p-4">
                                    <h3 class="h5 text-white">@spotlight.Title</h3>
                                    <p class="text-secondary mb-4">@spotlight.Description</p>
                                    <a class="btn btn-ghost btn-sm" href="@spotlight.ActionUrl">@spotlight.ActionLabel</a>
                                </div>
                            </article>
                        </div>
                    }
                </div>
            </div>
        </section>
    </div>
}

@functions {
    private static string FormatRelease(DateTime releaseDate) => releaseDate.ToString("dd MMM yyyy");
}
