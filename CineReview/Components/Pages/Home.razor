@page "/"
@using System.Linq
@using CineReview.Components.Shared
@inject IMovieDataProvider MovieDataProvider

<PageTitle>CineReview</PageTitle>

@if (_homeData is null)
{
	<section class="container-xl py-5 my-5 text-center">
		<div class="spinner-border text-info" role="status"></div>
	</section>
}
else
{
	<div class="home-page">
		<section class="home-hero position-relative overflow-hidden">
			<div class="home-hero__backdrop" style="background-image: url('@_homeData.Featured.BackdropUrl');"></div>
			<div class="home-hero__overlay"></div>
			<div class="container-xl position-relative">
				<div class="row align-items-center g-5 py-5">
					<div class="col-lg-7">
						<div class="d-flex align-items-center gap-3 mb-4 flex-wrap">
							<span class="badge chip chip--primary">Phim nổi bật</span>
							<span class="text-secondary text-uppercase small fw-semibold">@_homeData.Featured.ReleaseDate.ToString("dd MMM yyyy")</span>
						</div>
						<h1 class="display-4 fw-bold mb-3 text-white">@_homeData.Featured.Title</h1>
						<p class="lead text-light-emphasis mb-4">@_homeData.Featured.Tagline</p>
						<p class="text-secondary-emphasis mb-4">@_homeData.Featured.Overview</p>
						<div class="home-hero__actions d-flex flex-wrap gap-3 mb-4">
							<a class="btn btn-primary btn-glow" href="@($"/movies/{_homeData.Featured.Id}")">Khám phá chi tiết</a>
							<a class="btn btn-ghost" href="#now-playing">Xem suất chiếu</a>
						</div>
						<div class="home-hero__meta">
							<div>
								<span class="text-secondary">Điểm cộng đồng</span>
								<span class="fw-semibold text-white">@_homeData.Featured.CommunityScore.ToString("0.0")</span>
							</div>
							<div>
								<span class="text-secondary">Trạng thái review</span>
								@if (_homeData.Featured.RequiresTicketVerification)
								{
									<span class="badge chip chip--danger fw-semibold">Cần xác thực vé</span>
								}
								else
								{
									<span class="badge chip chip--success fw-semibold">Tự do review</span>
								}
							</div>
						</div>
					</div>
					<div class="col-lg-5">
						<div class="home-hero__poster-card">
							<div class="ratio ratio-2x3 rounded-4 overflow-hidden shadow-lg">
								<img src="@_homeData.Featured.PosterUrl" alt="Poster @_homeData.Featured.Title" class="w-100 h-100 object-fit-cover" loading="lazy" />
							</div>
							<div class="home-hero__poster-meta">
								<span class="badge chip chip--muted">@string.Join(" • ", _homeData.Featured.Genres.Take(3))</span>
								<span class="text-secondary">@FormatRelease(_homeData.Featured.ReleaseDate)</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<section id="now-playing" class="home-section">
			<div class="container-xl">
				<div class="section-header">
					<div>
						<h2 class="h3 text-white mb-1">Đang chiếu nổi bật</h2>
						<p class="text-secondary mb-0">Các suất chiếu đang mở bán, hãy xác thực vé để bật review.</p>
					</div>
					<a class="btn btn-ghost btn-sm" href="#showtimes">Xem tất cả</a>
				</div>
				<div class="row g-4">
					@foreach (var movie in _homeData.NowPlaying)
					{
						<div class="col-12 col-sm-6 col-lg-4 col-xl-3">
							<MovieCard Movie="movie" />
						</div>
					}
				</div>
			</div>
		</section>

		<section id="coming-soon" class="home-section">
			<div class="container-xl">
				<div class="section-header">
					<div>
						<h2 class="h3 text-white mb-1">Sắp công chiếu</h2>
						<p class="text-secondary mb-0">Đặt nhắc lịch để không bỏ lỡ vé early-access.</p>
					</div>
					<a class="btn btn-ghost btn-sm" href="#alerts">Đăng ký nhắc lịch</a>
				</div>
				<div class="row g-4">
					@foreach (var movie in _homeData.ComingSoon)
					{
						<div class="col-12 col-sm-6 col-lg-4 col-xl-3">
							<MovieCard Movie="movie" />
						</div>
					}
				</div>
			</div>
		</section>

		<section id="latest-reviews" class="home-section home-section--tinted">
			<div class="container-xl">
				<div class="section-header">
					<div>
						<h2 class="h3 text-white mb-1">Review mới nhất</h2>
						<p class="text-secondary mb-0">Tổng hợp phản hồi từ cộng đồng CineReview.</p>
					</div>
					<a class="btn btn-ghost btn-sm" href="#communities">Vào cộng đồng</a>
				</div>
				<div class="row g-4">
					@foreach (var review in _homeData.LatestReviews)
					{
						<div class="col-12 col-lg-6">
							<div class="review-card h-100">
								<div class="d-flex align-items-start gap-3">
									<img src="@review.AvatarUrl" alt="Avatar @review.Author" class="rounded-circle flex-shrink-0 review-card__avatar" loading="lazy" />
									<div class="flex-grow-1">
										<div class="d-flex justify-content-between align-items-center mb-1">
											<h3 class="h6 text-white mb-0">@review.Author</h3>
											<span class="badge chip chip--warning">@review.Rating/10</span>
										</div>
										<div class="text-secondary small mb-2">
											<span>@review.ContextLabel</span>
											<span class="mx-2">•</span>
											<span>@review.CreatedAt.ToString("dd/MM/yyyy")</span>
										</div>
										<p class="text-secondary mb-2">@review.Excerpt</p>
										<div class="d-flex align-items-center gap-2 small">
											@if (review.IsTicketVerified)
											{
												<span class="badge chip chip--success">Đã xác thực vé</span>
											}
											@if (!string.IsNullOrWhiteSpace(review.Location))
											{
												<span class="text-secondary">@review.Location</span>
											}
										</div>
									</div>
								</div>
							</div>
						</div>
					}
				</div>
			</div>
		</section>

		<section id="insights" class="home-section">
			<div class="container-xl">
				<div class="section-header">
					<div>
						<h2 class="h3 text-white mb-1">Bài viết & hướng dẫn</h2>
						<p class="text-secondary mb-0">Tin tức, kinh nghiệm xác thực vé và mẹo review chất lượng.</p>
					</div>
					<a class="btn btn-ghost btn-sm" href="#">Xem thêm bài viết</a>
				</div>
				<div class="row g-4">
					@foreach (var spotlight in _homeData.EditorialSpots)
					{
						<div class="col-12 col-lg-6">
							<article class="editorial-card h-100">
								<div class="editorial-card__image rounded-4 overflow-hidden">
									<img src="@spotlight.ImageUrl" alt="@spotlight.Title" class="w-100 h-100 object-fit-cover" loading="lazy" />
								</div>
								<div class="p-4">
									<h3 class="h5 text-white">@spotlight.Title</h3>
									<p class="text-secondary mb-4">@spotlight.Description</p>
									<a class="btn btn-ghost btn-sm" href="@spotlight.ActionUrl">@spotlight.ActionLabel</a>
								</div>
							</article>
						</div>
					}
				</div>
			</div>
		</section>
	</div>
}

@code {
	private HomePageData? _homeData;

	protected override async Task OnInitializedAsync()
	{
		_homeData = await MovieDataProvider.GetHomeAsync();
	}

	private static string FormatRelease(DateTime releaseDate)
		=> releaseDate.ToString("dd MMM yyyy");
}
